<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=10">
        <title>Daily Report Manager</title>
        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="css/pagination.css" rel="stylesheet" type="text/css">
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 10]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <script src="js/jquery.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <!-- Validate Plugin -->
        <script src="js/jquery.validate.min.js" type="text/javascript"></script>
        <script src="js/jquery.pagination.js" type="text/javascript"></script>
        <script src="js/common.js" type="text/javascript"></script>

        <style type="text/css">
            .margin-top-05 { margin-top: 0.5em; }
            .margin-top-10 { margin-top: 1.0em; }
            .margin-top-15 { margin-top: 1.5em; }
            .margin-top-20 { margin-top: 2.0em; }
            .margin-clear{ margin: 0}

            .padding-05 { padding: 0.5em; }
            .padding-10 { padding: 1.0em; }
            .padding-15 { padding: 1.5em; }
            .padding-20 { padding: 2.0em; }

            .txt-center{text-align: center;}

            .font-bold {font-weight: 700; }
            .top-buffur {top: 8em}

            fieldset.scheduler-border {
                border: 1px solid #ddd !important;
                padding: 0 1.4em 1.4em 1.4em !important;
                margin: 0 0 1.5em 0 !important;
                -webkit-box-shadow:  0px 0px 0px 0px #000;
                        box-shadow:  0px 0px 0px 0px #000;
                border-radius: 4px;
            }
            textarea{ resize: vertical;}
            img {vertical-align: text-top;}

            legend.scheduler-border {
                font-size: 1.2em !important;
                font-weight: bold !important;
                text-align: left !important;
                width:auto;
                padding:0 10px; 
                border-bottom:none;

            }
            #pagination .pagination{
                margin: 0;
            }
            #collapse{text-decoration: none;}

            #issues-wrap div.row.well{
                margin-top: -15px;
                border-radius: 0;
            }
            #report-tb tr td{
                vertical-align: middle;
            }
            #loginDialog {
                position: absolute;
                top: 15%;
                left: 50%;
                margin-left: -200px;
                padding: 20px;
            }

             #loginDialog div.modal-content{
                width: 400px;
                background-color: #eee;
            }

            body {
                padding-bottom: 40px;
                background-color: #eee;
            }
            .input-group-addon.danger {
                color: rgb(255, 255, 255);
                background-color: rgb(217, 83, 79);
                border-color: rgb(212, 63, 58);
            }
            .input-group-addon.success {
                color: rgb(255, 255, 255);
                background-color: rgb(92, 184, 92);
                border-color: rgb(76, 174, 76);
            }
            .input-group-addon.info {
                color: rgb(255, 255, 255);
                background-color: rgb(57, 179, 215);
                border-color: rgb(38, 154, 188);
            }
            
            .report-tip{
                text-align: center;
                padding: 15px;
            }
            .form-signin {
              max-width: 330px;
              padding: 15px;
              margin: 0 auto;
            }
            .form-signin .form-signin-heading,
            .form-signin .checkbox {
              margin-bottom: 10px;
            }
            .form-signin .checkbox {
              font-weight: normal;
            }
            .form-signin .form-control {
              position: relative;
              height: auto;
              -webkit-box-sizing: border-box;
                 -moz-box-sizing: border-box;
                      box-sizing: border-box;
              padding: 10px;
              font-size: 16px;
            }
            .form-signin .form-control:focus {
              z-index: 2;
            }
            .form-signin input[type="email"] {
              margin-bottom: -1px;
              border-bottom-right-radius: 0;
              border-bottom-left-radius: 0;
            }
            .form-signin input[type="password"] {
              margin-bottom: 10px;
              border-top-left-radius: 0;
              border-top-right-radius: 0;
            }
            .has-error{
                border: 1px solid red;
            }

        </style>
    </head>
    <body>
        <div class="container panel panel-primary margin-top-10">
            <div class="row panel-heading">
                <div class="col-sm-4 text-left">
                    <h4 class="panel-title"> DDRT Log Work</h4>
                </div>
                <div class="col-sm-8 text-right">
                    <p id="reportUser" class="panel-title">
                        <img id="useravatar" src="http://jira/secure/useravatar?size=small&avatarId=10122" />
                        <a id="curUser" href="javascript:void(0)" class="font-bold">hh49</a>&nbsp;&nbsp;
                        <a id="loginOut" href="javascript:void(0)">Logout</a>
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 margin-top-15">
                    <div id="issuePanel" class="panel panel-info">
                        <div class="panel-heading">
                            <h3 class="panel-title"> <b>Issues</b>
                                &nbsp;&nbsp;
                                <small>choose project and status,can faster find your issues</small>
                                <a id="collapse" href="javascript:void(0)" style="" class="glyphicon glyphicon-collapse-down pull-right" aria-hidden="true"></a>
                            </h3>

                        </div>
                        <div id="issues-wrap" class="panel-body">
                            <div class="row well">
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <span class="input-group-addon success font-bold">Projects</span>
                                        <select id="selProject" class="form-control">
                                            <option value="-1">All</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <span class="input-group-addon info font-bold">status</span>
                                        <div class="form-control">
                                            <label for="0" class="checkbox-inline" title="The issue is open and ready for the assignee to start work on it.">
                                                <input type="checkbox" name="status" id="0" value="Open" />                        
                                                Open
                                            </label>
                                            <label for="1" class="checkbox-inline"  title="This issue is being actively worked on at the moment by the assignee.">
                                                <input type="checkbox"  checked="checked" name="status" id="1" value="In Progress" />                        
                                                In Progress
                                            </label>
                                            <label for="2" class="checkbox-inline"  title="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">
                                                <input type="checkbox" name="status" id="2" value="Reopened" />                        
                                                Reopened
                                            </label>
                                            <label for="3" class="checkbox-inline"  title="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">
                                                <input type="checkbox" name="status" id="3" value="Resolved" />                        
                                                Resolved
                                            </label>
                                            <label for="4" class="checkbox-inline"  title="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">
                                                <input type="checkbox" checked="checked"  name="status" id="4" value="Closed" />                        
                                                Closed
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-sm-12 table-responsive">
                                <!-- <hr class="font-bold" /> -->
                                <table  class="table table-hover table-condensed">
                                    <thead>
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="10%">T</th>
                                            <th width="15%">Key</th>
                                            <th>Summary</th>
                                            <th width="8%">Operation</th>
                                        </tr>
                                    </thead>
                                    <tbody id="issues-tb">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="panel-footer clearfix">
                            <div id="pagination" class="margin-clear pull-right">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <form id="reportFrom" method="post" action="api/v1/jira/worklog">
                        <fieldset id="reports" class="scheduler-border form-group" >
                            <legend class="scheduler-border">
                                <label class="control-label">Report Content
                                    <!-- <button id="add_report" type="button" class="btn btn-default btn-xs font-bold" title="add a report" >    +
                                    </button> -->
                                </label>
                            </legend>
                            <div class="table-responsive">
                                <!-- <hr class="font-bold" /> -->
                                <table  class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="20%">Key</th>
                                            <th>Report Summary</th>
                                            <th width="15%">Time Spent (H)</th>
                                            <th width="5%">Operation</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-tb">
                                        <!-- <tr>
                                            <th>test</th>
                                            <td><textarea class="form-control" rows="1" placeholder="Enter your today's report" name="content" ></textarea></td>
                                            <td><input name="timeSpent" type="text" class="form-control"  value="8" placeholder="hours"></td>
                                            <td class="txt-center"><button type="button" name="close" title="remove this report" class="btn btn-default btn-xs">X</button></td>
                                        </tr> -->
                                    </tbody>
                                </table>
                                <p id="tipInfo" class="bg-info report-tip">Please add report from <a href="#issuePanel">issues.</a></p>
                            </div>
                            <div class="col-sm-2 col-sm-offset-5 form-group">
                                <button  id="submitReport" data-loading-text="Loading..." type="submit" class="btn btn-primary btn-lg btn-block">Submit</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
                
            </div>
        </div> 
           
        <!-- Button trigger modal -->
       <!--  <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
          Launch login modal
        </button> -->
        <!-- Modal -->
        <div id="loadingModal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <img src="" alt="loding issue, please waiting...." />
        </div>
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div id="loginDialog" class="modal-dialog" role="document">
            <div  class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" aria-label="Close"><span aria-hidden="true">::</span></button>
                <h4 class="modal-title" id="myModalLabel">Please sign in</h4>
              </div>
              <div class="modal-body">

                <form id="loginForm" class="form-signin" role="form" action="api/v1/jira/login" method="post">
                    <label for="username" class="sr-only">Username</label>
                    <input type="text" name="username" id="username" class="form-control" placeholder="Username" required autofocus>
                    <label for="inputPassword" class="sr-only">Password</label>
                    <input type="password" name="password" id="password" class="form-control" placeholder="Password" required>
                    <input type="hidden" name="info" value="true" />
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="remember-me" /> Remember me
                      </label>
                    </div>
                    <input id="loginBtn" class="btn btn-lg btn-primary btn-block" type="submit" value="Sign in" />
                </form> 

              </div>
              <!-- <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Sign in</button>
              </div> -->
            </div>
          </div>
        </div>


        <script type="text/javascript">
            var pageSize = 10;
            var selected = [];
            var checkedTag = '<span class="glyphicon glyphicon-ok pull-right" aria-hidden="true"></span>';

            $(document).ready(function(){
                $('#loginForm').validate({
                    rules: {
                        username: {
                            minlength: 4,
                            maxlength: 20, 
                            required: true
                        },
                        password: {
                            minlength: 6,
                            maxlength: 16, 
                            required: true
                        }
                    },

                    errorElement: 'span',
                    errorClass: 'help-block',
                    highlight: function(element) {
                        //console.log("error");
                        //$('#errorModal').modal(options);
                        $(element).addClass('has-error');
                    },
                    unhighlight: function(element) {
                        //console.log("ok");
                        //$('#errorModal').modal(options);
                        $(element).removeClass('has-error');
                    },
                    submitHandler:function(form){
                        var loginForm$ = $(form);
                        
                         $.ajax({
                            url: loginForm$.attr("action"),
                            method:"POST", 
                            dataType: "json",
                            cache:false,
                            data:loginForm$.serialize(),
                            success: function(data, status, xhr){
                                setUser(data);
                                 initPagination();
                            },
                           
                        });

                        return false;
                    }

                });

                $.Deferred(initUser).done(function(){
                    initPagination();
                });
                 
                $("#issues-wrap select, #issues-wrap :checkbox").change(function(){
                    initPagination();
                });

                $("#issues-wrap").on("click", "#issues-tb :button", function(){
                    var btn = $(this);
                    var curIssue = btn.parent().prev().prev().find("a");
                    var flyIssue = curIssue.clone();
                    flyIssue.css({
                        'z-index': 9000,
                        'display': 'block',
                        'position': 'absolute',
                        'top': curIssue.offset().top +'px',
                        'left': curIssue.offset().left +'px',
                        'width': curIssue.width() +'px',
                        'height': curIssue.height() +'px'
                    });
                    var reportObj = $("#"+ curIssue.text());
                    var exist = reportObj.length === 0;
                    if (exist) {
                        var objId = curIssue.text();
                        selected.push(objId);
                        reportObj = $("<tr id="+ objId +"><th></th> \
                                                <td> \
                                                    <textarea class=\"form-control\" rows=\"1\"  \
                                                        placeholder=\"Enter your today's report\" name=\"content\" ></textarea> \
                                                </td> \
                                                <td>  \
                                                <input name=\"timeSpent\" type=\"text\" class=\"form-control\"  value=\"8\" \
                                                     placeholder=\"hours\"> \
                                                </td> \
                                                <td class=\"txt-center\"> \
                                                    <button type=\"button\" name=\"close\" title=\"remove this report\" \
                                                    class=\"btn btn-default btn-xs\">X</button> \
                                                </td></tr>");
                        reportObj.appendTo("#report-tb");
                    }
                    var reportKey = reportObj.find("th");
                    $('body').append(flyIssue);
                    flyIssue.animate({
                        top: reportKey.offset().top,
                        left: reportKey.offset().left,
                        width: 20,
                        height: 10
                    }, 'slow', function() {
                        exist?(flyIssue.appendTo(reportKey), flyIssue.removeAttr('style')):flyIssue.remove();
                    });
                    if (btn.next().length === 0) {
                        btn.after(checkedTag);
                     }
                   
                });

                $("#collapse").on("click", function(){
                    var collapse$ = $(this);
                    var wrap$ = $("#issues-wrap")
                    if(collapse$.hasClass("glyphicon-collapse-up")){
                        wrap$.slideDown("slow", function(){
                            wrap$.next().slideDown();
                            collapse$.removeClass("glyphicon-collapse-up").addClass("glyphicon-collapse-down");
                        });
                    }else{
                        wrap$.slideUp("slow", function(){
                            wrap$.next().slideUp();
                            collapse$.removeClass("glyphicon-collapse-down").addClass("glyphicon-collapse-up");
                        });
                    }
                });

                $("#loginOut").on("click", function(){
                    sendDelete("api/v1/jira/login", {"content-type":"application/json"}, function(){
                        window.location.href = "/login.html";
                    });
                });

                $("#reports").on("click", "button[name=close]", function(e){
                    var rself$ = $(this);
                    var wrap$ = rself$.closest("tr");
                    wrap$.fadeOut("slow", function(){
                        wrap$.remove();
                        key = wrap$.attr("id");
                        selected.remove(key);
                        var temp = $("#issues-tb :button[name="+key+"]");
                        temp.length === 0 || temp.next().remove();
                        
                    });
                });

            });
            
            function getBrowseUrl(key){
                return "http://jira/browse/" + key;
            };

            function isSelected(key){
                return $.inArray(key, selected) !== -1;
            };

            function removeSelected(key){

            };

            // $("#add_report").on("click", function() {
            //     var fieldset$ = $("#reports");
            //     var cloneItem = fieldset$.children("div.row").last().clone(true);
            //     fieldset$.append("<hr />");
            //     cloneItem.appendTo(fieldset$);
            // });

            var initProjects =  function(){
               $.getJSON("api/v1/jira/project", function(data){
                    var projectSel = $("#selProject");
                    projectSel.empty();
                    projectSel.append('<option value="-1">All</option>');
                    $.each(data, function(k,v){
                        projectSel.append('<option key='+ v.key +' value="' +v.id+ '">'+v.name+'</option>');
                    });
               });
            };

            var pageCallback = function(index, jq) { 
                //if (index > 0) {
                    initIssue(index);  
               // };    
            }; 

            var showIssues = function(issues){
                var issueWrap = $("#issues-tb");
                issueWrap.children().remove();
                $.each(issues, function(k, v){
                    issueWrap.append(('<tr><th scope="row">'+ (k + 1)
                                    +'</th><td><img src="'
                                    + v.fields.issuetype.iconUrl+'" height="16" width="16" border="0" align="absmiddle" title="'
                                    + v.fields.issuetype.description+'">'
                                    + v.fields.issuetype.name+'</td><td><a href="'+ getBrowseUrl(v.key) +'" target="_blank">'
                                    + v.key +'</a></td><td>'
                                    + (v.fields.description || "N/A") +'</td><td><button type="button" name='
                                    + v.key +' class="btn btn-default btn-xs font-bold" title="add a report"> + </button>'
                                    + (isSelected(v.key)?checkedTag:'') + '</td></tr>'));
                 });
             };
           //<span class="glyphicon glyphicon-ok pull-right" aria-hidden="true"></span>
           var initPagination = function(){
                var query = buildJQL();
                var issueWrap = $("#issues-tb");
                issueWrap.children().remove();
                query && $.post("api/v1/jira/search", JSON.stringify(query), function(data){
                    showIssues(data.issues);
                    
                    $("#pagination").pagination(data.total, {
                        callback: pageCallback, 
                        prev_text: "prev",
                        next_text: "next",
                        items_per_page: pageSize,
                        num_edge_entries: 2,
                        show_if_single_page: true,
                        load_first_page:false,
                        link_to: "javascript:void(0)"
                    });
                    
                });
            };

            var initIssue = function(pageIndex){
                var query = buildJQL();
                query.startAt = pageIndex * pageSize - 1;
                query && $.post("api/v1/jira/search", JSON.stringify(query), function(data){
                    showIssues(data.issues);
                });
            };

            var showLoading = function(){

            };

            var submitReport = function(){
                var reports = [], item, content = "";
                 $("#reports div[name=item]").each(function(){
                    item = buildItem(this)
                    reports.push(item);
                    content += item.comment;
                });

                 var reportObj = {"reports": reports, "email":$("#curUser").data().emailAddress, "content": content};
                $.post("api/v1/jira/worklog",  JSON.stringify(reportObj), function(data){
                    console.log(data);
                    alert(data);
                });
               return false;
            };

            var buildItem = function(item){
                var item$ = $(item);
                var reportItem = {};
                reportItem.comment = item$.find("textarea[name=content]").val();
                reportItem.id = item$.find("select[name=issue]").val();
                reportItem.timeSpent = item$.find("input:text[name=timeSpent]").val();
                return reportItem;
            }

            
            var buildJQL = function(){
                var jql = "assignee='" + $("#curUser").data().name + "' and ";
                var project$ = $("#selProject option:selected");
                if (project$.val() != -1) {
                    jql += "project='" + project$.text() + "' and ";
                }
                var status = $("#issues-wrap input:checkbox[name=status]:checked");
                if (status.size() < 1) {
                    //alert("At least choose a status");
                    return;
                }
                var statusArr = [];
                status.each(function(){
                    statusArr.push(this.value);
                });
                jql += "status in ('" + statusArr.join("','") + "') order by created, priority desc";
                var query = {};
                query.jql = jql;
                query.startAt = 0;
                query.maxResults = pageSize;
                query.fields = ["id", "key", "description", "issuetype"];
                return query;
            };

            var sendDelete = function(url, headers, success_call){
                $.ajax({
                      type: "DELETE",
                      url: url,
                      cache:false,
                      dataType:"json",
                      headers:headers,
                      success: success_call
                  }); 
             };

            var initUser = function(dtd){
                $.ajax({
                    url: "/api/v1/jira/user",
                    method:"GET", 
                    dataType: "json",
                    success: function(data){
                        setUser(data);
                        dtd.resolve();
                    },
                    error: function(jqXHR){
                        $("#myModal").modal({'backdrop':'static', 'keyboard':false});
                        dtd.reject();
                    }
                    
                });

                dtd.promise();
            };
            var setUser = function(data){
                var titlePanle$ = $("#reportUser");
                titlePanle$.find("img").attr("src", data.avatarUrls["16x16"]).next().html(data.displayName).data(data);
                $("#myModal").modal("hide");
                initProjects();
                //initStatus();
            };

        </script>

        
    </body>
</html>