var worklog={global:{pageSize:5,selected:[],checkedTag:'<span class="glyphicon glyphicon-ok pull-right" aria-hidden="true"></span>'},autoResizeOption:{rows:1,cols:75,maxRow:10},getReportObj:function(a){return $("<tr id="+a+'><th></th><td><textarea class="form-control" rows="1" placeholder="Enter your today\'s report" name="content" data-container="body" data-toggle="popover" data-placement="right"></textarea></td><td><input  maxlength="4" name="timeSpent" type="text" class="form-control" placeholder="hours" data-container="body" data-toggle="popover" data-placement="right"></td><td class="txt-center"> <button type="button" name="close" title="remove this report" class="btn btn-default btn-xs">X</button></td></tr>')}};$.validator.addMethod("timeSpent",function(b,a){return this.optional(a)||/^\d+(.\d)?$/.test(b)},"After the decimal point, only one digit can be kept.");$(document).ready(function(){$("#loginForm").validate({rules:{username:{minlength:4,maxlength:20,required:true},password:{minlength:6,maxlength:16,required:true}},errorElement:"span",errorClass:"help-block",highlight:function(a){$(a).addClass("has-error")},unhighlight:function(a){$(a).removeClass("has-error")},submitHandler:function(b){var c=$(b);var a=c.find("#loginBtn").button("loading");$.ajax({url:c.attr("action"),method:"POST",dataType:"json",cache:false,data:c.serialize(),success:function(e,d,f){closeLogin();showLoading("Init user, please waiting...");setUser(e);orderInit()},error:function(g,e,f){a.button("reset");var d=$("#loginTip");d.html("Login failed! message:"+e+";"+f);d.fadeIn("slow",function(){window.setTimeout(function(){d.fadeOut("slow")},3000)})}});return false}});initUser().done(orderInit).fail(closeLoading).fail(showLogin);$("#selProject, #selStatus").change(function(){if(!$("#collapse").data.init){$("#collapse").data("init",true)}initPagination()});$("#issues-wrap").on("click","#issues-tb :button",function(){var d=$(this),h=d.parent(),j=h.prev(),f=j.prev().find("a"),g=$('<p class="issue-summary"></p>'),c=$("<i></i>");c.html(h.prev().text());g.append(f.clone()).append(c);g.css({"z-index":9000,"display":"block","position":"absolute","top":f.offset().top+"px","left":f.offset().left+"px","width":f.width()+j.width()+"px","height":f.height()+j.height()+"px"});var e=$("#"+f.text());var i=e.length!==0;if(!i){var b=f.text();worklog.global.selected.push(b);e=worklog.getReportObj(b);e.appendTo("#report-tb").data({key:b,action:"create"});e.find("textarea").textareaAutoResize(worklog.autoResizeOption)}else{if(e.data().action==="delete"){e.append(e.data().children);e.data().action="update";e.show()}}var a=e.find("th");$("body").append(g);g.animate({top:a.offset().top,left:a.offset().left,width:20,height:10,display:"none"},"slow",function(){i?g.remove():(g.appendTo(a),g.removeAttr("style"),c.css("display","block").html(formatSummary(c.html())))});if(d.next().length===0){d.after(worklog.global.checkedTag)}});$("#collapse").on("click",function(){var b=$(this);var a=function(){var c=$("#issues-wrap");if(b.hasClass("glyphicon-collapse-up")){c.slideDown("slow",function(){b.removeClass("glyphicon-collapse-up").addClass("glyphicon-collapse-down");c.next().fadeIn()})}else{c.slideUp("slow",function(){b.removeClass("glyphicon-collapse-down").addClass("glyphicon-collapse-up");c.next().slideUp("fast")})}};if(!b.data().init){initProjects().done(function(){initPagination();b.data("init",true);a()}).fail(closeLoading)}else{a()}});$("#loginOut").on("click",function(){sendDelete("api/v1/jira/login",{"content-type":"application/json"},function(){window.location.href="/login.html"})});$("#reports").on("click","button[name=close]",function(b){var c=$(this);var a=c.closest("tr");a.fadeOut("slow",function(){if(a.data("action")==="create"){a.remove()}else{a.data("action","delete");a.data("children",a.children().detach())}key=a.attr("id");worklog.global.selected.remove(key);var d=$("#issues-tb :button[name="+key+"]");d.length===0||d.next().remove()})});$("#add-other input[type=text]").on("keydown",function(a){a.which===13&&$(this).next().trigger("click")});$("#add-other span.btn").on("click",function(){var b=$(this).prev();var a=b.val();if($.trim(a)===""){b.addClass("has-error");window.setTimeout(function(){b.removeClass("has-error")},1000);return}var c={jql:"key='"+a+"'",fields:["id","key","summary","issuetype"]};initPagination(c)});$("#reportForm").validate({rules:{content:{minlength:4,required:true},timeSpent:{number:true,timeSpent:true,maxlength:4,range:[0.5,24],required:true}},highlight:function(a){$(a).addClass("has-error")},unhighlight:function(a){$(a).removeClass("has-error").popover("destroy")},submitHandler:submitReport,errorPlacement:function(a,b){$(b).popover("destroy").popover({"content":a.text(),"trigger":"hover"})}});$(document).click(function(){$("#collapse").popover("destroy")})});function showLoading(c,b){var a=$("#loadingModal");b?a.find("img").hide():a.find("img").show();c&&a.find("span").html(c);a.modal({"backdrop":"static","keyboard":false})}function closeLoading(){$("#loadingModal").modal("hide")}function showLogin(){$("#myModal").modal({"backdrop":"static","keyboard":false})}function closeLogin(){$("#myModal").modal("hide")}function orderInit(){var a=function(){$("#reportForm textarea").textareaAutoResize({rows:1,cols:75,maxRow:10});closeLoading();$("#collapse").popover({"content":"Hey, Welcome DDRT. Click here to add more issue !"}).popover("show")};loadTodayIssues(a)}function getBrowseUrl(a){return"http://jira/browse/"+a}function isSelected(a){return $.inArray(a,worklog.global.selected)!==-1}var pageCallback=function(a,b){initIssue(a).then(closeLoading)};var showIssues=function(b,c){var a=$("#issues-tb");!c&&a.children().remove();$.each(b.issues,function(e,d){a.append(('<tr><th scope="row">'+(e+1)+'</th><td><img src="'+d.fields.issuetype.iconUrl+'" height="16" width="16" border="0" align="absmiddle" title="'+d.fields.issuetype.description+'">'+d.fields.issuetype.name+'</td><td><a href="'+getBrowseUrl(d.key)+'" target="_blank">'+d.key+"</a></td><td>"+(d.fields.summary||"N/A")+'</td><td><button type="button" name='+d.key+' class="btn btn-default btn-xs font-bold" title="add a report"> + </button>'+(isSelected(d.key)?worklog.global.checkedTag:"")+"</td></tr>"))})};var initPagination=function(b){var b=b||buildJQL();var a=$("#issues-tb");a.children().remove();return sendAjax("api/v1/jira/search",function(){showLoading("Loding issue, please waiting...")},function(c){showIssues(c);$("#pagination").pagination(c.total,{callback:pageCallback,prev_text:"prev",next_text:"next",items_per_page:worklog.global.pageSize,num_edge_entries:2,num_display_entries:5,show_if_single_page:true,load_first_page:false,link_to:"javascript:void(0)"})},false,"POST",JSON.stringify(b)).done(closeLoading).fail(function(){showLoading("Not found issue".fontcolor("red"),true);window.setTimeout(closeLoading,1000)})};var initIssue=function(a){var b=buildJQL();b.startAt=a*worklog.global.pageSize;return searchIssues(b,showIssues)};var searchIssues=function(b,a){return sendAjax("api/v1/jira/search",function(){showLoading("Loding issue, please waiting...")},function(c){a(c)},false,"POST",JSON.stringify(b))};var submitReport=function(e){var d=$("#reports table tbody tr:visible");if(d.size()===0){alert("At least one report, please add from Issues!");return}showLoading("submit, please waiting...");var c={"create":[],"update":[],"delete":[]},b,f="";$("#reports table tbody tr").each(function(){var g=$(this);f=g.data("action");item=buildItem(g,f);c[f].push(item)});var a=$("#curUser");c.userId=a.data().userId;c.username=a.data().displayName;c.loginId=a.data().name;$.post("api/v1/jira/worklog",JSON.stringify(c)).done(function(g){showLoading("submit success",true);resetForm(g,e);window.setTimeout(closeLoading,3000)}).fail(function(){showLoading("Worklog failed, Please try again later!".fontcolor("red"),true);window.setTimeout(closeLoading,3000)});return false};function resetForm(data,form){var responseObj=eval(data);$("#reports table tbody tr").each(function(){var $tr=$(this);if($tr.is(":hidden")){$tr.remove()}else{if($tr.data().action==="create"){$tr.data("worklogId",findLodId(responseObj,$tr.data().key))}$tr.data().action="update";$tr.addClass("update")}})}function findLodId(b,a){for(var c=0;c<b.length;c++){if(b[c].issue===a){return b[c].id}}return 0}var buildItem=function(c,d){var b=c.data("worklogId");var a={};a.key=c.data("key");if(d==="delete"){if(!b){alert("data error")}a.id=b;return a}a.comment=c.find("textarea[name=content]").val();a.timeSpent=c.find("input:text[name=timeSpent]").val();if(b){a.id=b}return a};var buildJQL=function(){var a="assignee='"+$("#curUser").data().name+"' and ";var b=$("#selProject option:selected");if(b.val()!=-1){a+="project='"+b.text()+"' and "}a+="status='"+$("#selStatus option:selected").text()+"'";var c={};c.jql=a;c.startAt=0;c.maxResults=worklog.global.pageSize;c.fields=["id","key","summary","issuetype"];return c};var sendDelete=function(a,c,b){$.ajax({type:"DELETE",url:a,cache:false,dataType:"json",headers:c,success:b})};var initUser=function(){return sendAjax("/api/v1/jira/user",function(){showLoading("Check login, please waiting...")},setUser,false)};var initProjects=function(){return sendAjax("api/v1/jira/project",function(){showLoading("Init projects, please waiting...")},function(b){var a=$("#selProject");a.empty();a.append('<option value="-1">All</option>');$.each(b,function(d,c){a.append("<option key="+c.key+' value="'+c.id+'">'+c.name+"</option>")})})};var loadTodayIssues=function(a){sendAjax("api/v1/report/user/"+$("#curUser").data().userId+"/1",function(){showLoading("Init interface, please waiting...")},function(e){if(e.length===0){return searchOldLogedIssue(a)}var c=[];$.each(e,function(){c.push(this.issue)});var b="key in ('"+c.join("','")+"') order by created, priority desc";var d={jql:b,fields:["id","key","summary"]};searchIssues(d,function(f){initInterface(e,f)}).then(function(){a()})},false).fail(function(){a()})};var initInterface=function(e,f){var a=e.length,b=false,d;for(var c=0;c<a;c++){d=e[c].issue;b=worklog.getReportObj(d);b.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(d)+'" target="_blank">'+d+'</a><i style="display: block;">'+formatSummary(findIssue(f.issues,d).fields.summary||"")+"</i></p>");b.find("textarea").val(e[c].content||"").textareaAutoResize(worklog.autoResizeOption);b.find("input[name=timeSpent]").val(e[c].timeSpent||"");b.appendTo("#report-tb").data({key:d,worklogId:e[c].worklogId+"",action:"update"});b.addClass("update");worklog.global.selected.push(d)}};var initPrevInterface=function(e,f){var a=e.length,b=false,d;for(var c=0;c<a;c++){d=e[c].issue;b=worklog.getReportObj(d);b.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(d)+'" target="_blank">'+d+'</a><i style="display: block;">'+formatSummary(findIssue(f.issues,d).fields.summary||"")+"</i></p>");b.appendTo("#report-tb").data({key:d,action:"create"});b.find("textarea").textareaAutoResize(worklog.autoResizeOption);worklog.global.selected.push(d)}};var initInterfaceHistory=function(c){var a=c.issues.length,b=false;$.each(c.issues,function(){b=worklog.getReportObj(this.key);b.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(this.key)+'" target="_blank">'+this.key+'</a><i style="display: block;">'+(this.fields.summary||"")+"</i></p>");b.appendTo("#report-tb").data({key:this.key,action:"create"});b.find("textarea").textareaAutoResize(worklog.autoResizeOption);worklog.global.selected.push(this.key)})};var findIssue=function(a,c){for(var b=0;b<a.length;b++){if(a[b].key===c){return a[b]}}return false};var formatSummary=function(c){var e=0,a=c.length,b=-1;for(var d=0;d<a;d++){b=c.charCodeAt(d);if(b>=0&&b<=128){e+=1}else{e+=2}if(e>75){return c.substring(0,d)+"..."}}return c};function searchOldLogedIssue(a){sendAjax("api/v1/issue/prev/"+$("#curUser").data().userId,function(){showLoading("Init interface, please waiting...")},function(f){if(f.length===0){var c=$("#curUser").data().name;var b="assignee = "+c+" and issueFunction in workLogged('after -1d by "+c+"') and status != Closed";var e={jql:b,fields:["id","key","summary"]};return searchIssues(e,initInterfaceHistory).done(a).fail(a)}var d=[];$.each(f,function(){d.push(this.issue)});var b="key in ('"+d.join("','")+"') order by created, priority desc";var e={jql:b,fields:["id","key","summary"]};searchIssues(e,function(g){initPrevInterface(f,g)}).then(function(){a()})},false)}var setUser=function(b){var a=$("#reportUser");a.find("img").attr("src",b.avatarUrls["16x16"]).next().html(b.displayName).data(b)};function sendAjax(d,e,a,c,h,g,b){var f=$.Deferred();$.ajax({url:d,method:h||"GET",data:g,dataType:b||"json",beforeSend:e,success:function(j,k,i){if(a&&typeof a==="function"){a(j,k,i)}f.resolve()},error:function(i,k,j){if(c&&typeof c==="function"){c(i,k,j)}f.reject()}});return f.promise()};