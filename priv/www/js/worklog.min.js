var worklog={global:{pageSize:5,selected:[],checkedTag:'<span class="glyphicon glyphicon-ok pull-right" aria-hidden="true"></span>',cookieSplit:"[-@~@#]",ddrtSessionName:"ddrt_cur_session",needWelcomeName:"ddrt_show_welcome",needWelcome:function(){return !getCookie(this.needWelcomeName)}},autoResizeOption:{rows:1,cols:75,maxRow:10},getReportObj:function(b){return $("<tr id="+b+'><th></th><td><textarea class="form-control" rows="1" placeholder="Enter your today\'s report" name="content" data-container="body" data-toggle="popover" data-placement="right"></textarea></td><td><input  maxlength="4" name="timeSpent" type="text" class="form-control" placeholder="hours" data-container="body" data-toggle="popover" data-placement="right"></td><td class="txt-center"> <button type="button" name="close" title="remove this report" class="btn btn-default btn-xs">X</button></td></tr>')}};$.validator.addMethod("timeSpent",function(d,c){return this.optional(c)||/^\d+(.\d)?$/.test(d)},"After the decimal point, only one digit can be kept.");$(document).ready(function(){$("#loginForm").validate({rules:{username:{minlength:4,maxlength:20,required:!0},password:{minlength:6,maxlength:16,required:!0}},errorElement:"span",errorClass:"help-block",highlight:function(b){$(b).addClass("has-error")},unhighlight:function(b){$(b).removeClass("has-error")},submitHandler:function(e){var d=$(e),f=d.find("#loginBtn").button("loading");$.ajax({url:d.attr("action"),method:"POST",dataType:"json",cache:!1,data:d.serialize(),success:function(b,h,g){rememberMe(d.find("#rememberMe").prop("checked"));closeLogin();showLoading("Init user, please waiting...");setUser(b);orderInit()},error:function(h,c,j){f.button("reset");var i=$("#loginTip");i.html("Login failed! message:"+c+";"+j);i.fadeIn("slow",function(){window.setTimeout(function(){i.fadeOut("slow")},3000)})}});return !1}});initUser().done(orderInit).fail(closeLoading).fail(function(){var d=getSession();if(d){var c=$("#loginForm");c.find("#username").val(d[0]);c.find("#password").val(d[1]);c.find("#loginBtn").trigger("click")}else{showLogin()}});$("#selProject, #selStatus").change(function(){$("#collapse").data.init||$("#collapse").data("init",!0);initPagination()});$("#issues-wrap").on("click","#issues-tb :button",function(){var j=$(this),i=j.parent(),p=i.prev(),o=p.prev().find("a"),n=$('<p class="issue-summary"></p>'),m=$("<i></i>");m.html(i.prev().text());n.append(o.clone()).append(m);n.css({"z-index":9000,display:"block",position:"absolute",top:o.offset().top+"px",left:o.offset().left+"px",width:o.width()+p.width()+"px",height:o.height()+p.height()+"px"});var i=$("#"+o.text()),l=0!==i.length;l?"delete"===i.data().action&&(i.append(i.data().children),i.data().action="update",i.show()):(o=o.text(),worklog.global.selected.push(o),i=worklog.getReportObj(o),i.appendTo("#report-tb").data({key:o,action:"create"}),i.find("textarea").textareaAutoResize(worklog.autoResizeOption));var k=i.find("th");$("body").append(n);n.animate({top:k.offset().top,left:k.offset().left,width:20,height:10,display:"none"},"slow",function(){l?n.remove():(n.appendTo(k),n.removeAttr("style"),m.css("display","block").html(formatSummary(m.html())))});0===j.next().length&&j.after(worklog.global.checkedTag)});$("#collapse").on("click",function(){var d=$(this),c=function(){var a=$("#issues-wrap");d.hasClass("glyphicon-collapse-up")?a.slideDown("slow",function(){d.removeClass("glyphicon-collapse-up").addClass("glyphicon-collapse-down");a.next().fadeIn()}):a.slideUp("slow",function(){d.removeClass("glyphicon-collapse-down").addClass("glyphicon-collapse-up");a.next().slideUp("fast")})};d.data().init?c():initProjects().done(function(){initPagination();d.data("init",!0);c()}).fail(closeLoading)});$("#loginOut").on("click",function(){setCookie(worklog.global.ddrtSessionName,"",-1);sendDelete("api/v1/jira/login",{"content-type":"application/json"},function(){window.location.href="/login.html"})});$("#reports").on("click","button[name=close]",function(d){var c=$(this).closest("tr");c.fadeOut("slow",function(){"create"===c.data("action")?c.remove():(c.data("action","delete"),c.data("children",c.children().detach()));key=c.attr("id");worklog.global.selected.remove(key);var b=$("#issues-tb :button[name="+key+"]");0===b.length||b.next().remove()})});$("#add-other input[type=text]").on("keydown",function(b){13===b.which&&$(this).next().trigger("click")});$("#add-other span.btn").on("click",function(){var d=$(this).prev(),c=d.val();""===$.trim(c)?(d.addClass("has-error"),window.setTimeout(function(){d.removeClass("has-error")},1000)):initPagination({jql:"key='"+c+"'",fields:["id","key","summary","issuetype"]})});$("#reportForm").validate({rules:{content:{minlength:4,required:!0},timeSpent:{number:!0,timeSpent:!0,maxlength:4,range:[0.5,24],required:!0}},highlight:function(b){$(b).addClass("has-error")},unhighlight:function(b){$(b).removeClass("has-error").popover("destroy")},submitHandler:submitReport,errorPlacement:function(d,c){$(c).popover("destroy").popover({content:d.text(),trigger:"hover"})}});$(document).click(function(){$("#collapse").popover("destroy")})});function showLoading(e,d){var f=$("#loadingModal");d?f.find("img").hide():f.find("img").show();e&&f.find("span").html(e);f.modal({backdrop:"static",keyboard:!1})}function closeLoading(){$("#loadingModal").modal("hide")}function showLogin(){$("#myModal").modal({backdrop:"static",keyboard:!1})}function closeLogin(){$("#myModal").modal("hide")}function orderInit(){loadTodayIssues(function(){$("#reportForm textarea").textareaAutoResize({rows:1,cols:75,maxRow:10});closeLoading();worklog.global.needWelcome()&&$("#collapse").popover({content:"Hey, Welcome DDRT. Click here to add more issue !"}).popover("show");setCookie(worklog.global.needWelcomeName,"1",7);showAnimated("#reports","fadeInDown");showAnimated("#submitReport","fadeInUp")})}function getBrowseUrl(b){return"http://jira/browse/"+b}function isSelected(b){return -1!==$.inArray(b,worklog.global.selected)}var pageCallback=function(d,c){initIssue(d).then(closeLoading)},showIssues=function(e,d){var f=$("#issues-tb");!d&&f.children().remove();$.each(e.issues,function(g,c){f.append('<tr><th scope="row">'+(g+1)+'</th><td><img src="'+c.fields.issuetype.iconUrl+'" height="16" width="16" border="0" align="absmiddle" title="'+c.fields.issuetype.description+'">'+c.fields.issuetype.name+'</td><td><a href="'+getBrowseUrl(c.key)+'" target="_blank">'+c.key+"</a></td><td>"+(c.fields.summary||"N/A")+'</td><td><button type="button" name='+c.key+' class="btn btn-default btn-xs font-bold" title="add a report"> + </button>'+(isSelected(c.key)?worklog.global.checkedTag:"")+"</td></tr>")})},initPagination=function(b){b=b||buildJQL();$("#issues-tb").children().remove();return sendAjax("api/v1/jira/search",function(){showLoading("Loding issue, please waiting...")},function(c){showIssues(c);$("#pagination").pagination(c.total,{callback:pageCallback,prev_text:"prev",next_text:"next",items_per_page:worklog.global.pageSize,num_edge_entries:2,num_display_entries:5,show_if_single_page:!0,load_first_page:!1,link_to:"javascript:void(0)"})},!1,"POST",JSON.stringify(b)).done(closeLoading).fail(function(){showLoading("Not found issue".fontcolor("red"),!0);window.setTimeout(closeLoading,1000)})},initIssue=function(d){var c=buildJQL();c.startAt=d*worklog.global.pageSize;return searchIssues(c,showIssues)},searchIssues=function(d,c){return sendAjax("api/v1/jira/search",function(){showLoading("Loding issue, please waiting...")},function(b){c(b)},!1,"POST",JSON.stringify(d))},submitReport=function(g){if(0===$("#reports table tbody tr:visible").size()){alert("At least one report, please add from Issues!")}else{showLoading("submit, please waiting...");var f={create:[],update:[],"delete":[]},j="",i={};$("#reports table tbody tr").each(function(){var b=$(this);j=b.data("action");i=buildItem(b,j);f[j].push(i)});var h=$("#curUser");f.userId=h.data().userId;f.username=h.data().displayName;f.loginId=h.data().name;$.post("api/v1/jira/worklog",JSON.stringify(f)).done(function(a){showLoading("submit success",!0);resetForm(a,g);window.setTimeout(closeLoading,3000)}).fail(function(){showLoading("Worklog failed, Please try again later!".fontcolor("red"),!0);window.setTimeout(closeLoading,3000)});return !1}};function resetForm(a,b){var c=eval(a);$("#reports table tbody tr").each(function(){var a=$(this);a.is(":hidden")?a.remove():("create"===a.data().action&&a.data("worklogId",findLodId(c,a.data().key)),a.data().action="update",a.addClass("update"))})}function findLodId(e,d){for(var f=0;f<e.length;f++){if(e[f].issue===d){return e[f].id}}return 0}var buildItem=function(f,e){var h=f.data("worklogId"),g={};g.key=f.data("key");if("delete"===e){return h||alert("data error"),g.id=h,g}g.comment=f.find("textarea[name=content]").val();g.timeSpent=f.find("input:text[name=timeSpent]").val();h&&(g.id=h);return g},buildJQL=function(){var d="assignee='"+$("#curUser").data().name+"' and ",c=$("#selProject option:selected");-1!=c.val()&&(d+="project='"+c.text()+"' and ");d+="status='"+$("#selStatus option:selected").text()+"'";c={};c.jql=d;c.startAt=0;c.maxResults=worklog.global.pageSize;c.fields=["id","key","summary","issuetype"];return c},sendDelete=function(e,d,f){$.ajax({type:"DELETE",url:e,cache:!1,dataType:"json",headers:d,success:f})},initUser=function(){return sendAjax("/api/v1/jira/user",function(){showLoading("Check login, please waiting...")},setUser,!1)},initProjects=function(){return sendAjax("api/v1/jira/project",function(){showLoading("Init projects, please waiting...")},function(d){var c=$("#selProject");c.empty();c.append('<option value="-1">All</option>');$.each(d,function(b,e){c.append("<option key="+e.key+' value="'+e.id+'">'+e.name+"</option>")})})},loadTodayIssues=function(b){sendAjax("api/v1/report/user/"+$("#curUser").data().userId+"/1",function(){showLoading("Init interface, please waiting...")},function(a){if(0===a.length){return searchOldLogedIssue(b)}var f=[];$.each(a,function(){f.push(this.issue)});var e={jql:"key in ('"+f.join("','")+"') order by created, priority desc",fields:["id","key","summary"]};searchIssues(e,function(c){initInterface(a,c)}).then(function(){b()})},!1).fail(function(){b()})},initInterface=function(h,g){for(var l=h.length,k=!1,j,i=0;i<l;i++){j=h[i].issue,k=worklog.getReportObj(j),k.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(j)+'" target="_blank">'+j+'</a><i style="display: block;">'+formatSummary(findIssue(g.issues,j).fields.summary||"")+"</i></p>"),k.find("textarea").val(h[i].content||"").textareaAutoResize(worklog.autoResizeOption),k.find("input[name=timeSpent]").val(h[i].timeSpent||""),k.appendTo("#report-tb").data({key:j,worklogId:h[i].worklogId+"",action:"update"}),k.addClass("update"),worklog.global.selected.push(j)}},initPrevInterface=function(h,g){for(var l=h.length,k=!1,j,i=0;i<l;i++){j=h[i].issue,k=worklog.getReportObj(j),k.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(j)+'" target="_blank">'+j+'</a><i style="display: block;">'+formatSummary(findIssue(g.issues,j).fields.summary||"")+"</i></p>"),k.appendTo("#report-tb").data({key:j,action:"create"}),k.find("textarea").textareaAutoResize(worklog.autoResizeOption),worklog.global.selected.push(j)}},initInterfaceHistory=function(d){var c=!1;$.each(d.issues,function(){c=worklog.getReportObj(this.key);c.find("th").html('<p class="issue-summary"><a href="'+getBrowseUrl(this.key)+'" target="_blank">'+this.key+'</a><i style="display: block;">'+(this.fields.summary||"")+"</i></p>");c.appendTo("#report-tb").data({key:this.key,action:"create"});c.find("textarea").textareaAutoResize(worklog.autoResizeOption);worklog.global.selected.push(this.key)})},findIssue=function(e,d){for(var f=0;f<e.length;f++){if(e[f].key===d){return e[f]}}return !1},formatSummary=function(g){for(var f=0,j=g.length,i=-1,h=0;h<j;h++){if(i=g.charCodeAt(h),f=0<=i&&128>=i?f+1:f+2,75<f){return g.substring(0,h)+"..."}}return g};function searchOldLogedIssue(b){sendAjax("api/v1/issue/prev/"+$("#curUser").data().userId,function(){showLoading("Init interface, please waiting...")},function(a){if(0===a.length){var f=$("#curUser").data().name,f={jql:"assignee = "+f+" and issueFunction in workLogged('after -1d by "+f+"') and status != Closed",fields:["id","key","summary"]};return searchIssues(f,initInterfaceHistory).done(b).fail(b)}var e=[];$.each(a,function(){e.push(this.issue)});f="key in ('"+e.join("','")+"') order by created, priority desc";f={jql:f,fields:["id","key","summary"]};searchIssues(f,function(c){initPrevInterface(a,c)}).then(function(){b()})},!1)}var setUser=function(b){$("#reportUser").find("img").attr("src",b.avatarUrls["16x16"]).next().html(b.displayName).data(b)};function sendAjax(j,i,p,o,n,m,l){var k=$.Deferred();$.ajax({url:j,method:n||"GET",data:m,dataType:l||"json",beforeSend:i,success:function(e,c,f){p&&"function"===typeof p&&p(e,c,f);k.resolve()},error:function(e,d,f){o&&"function"===typeof o&&o(e,d,f);k.reject()}});return k.promise()}function showAnimated(d,c){$(d).addClass(c+" animated")}function rememberMe(d){if(d){d=$("#username").val();var c=$("#password").val();setCookie(worklog.global.ddrtSessionName,EnEight(d+worklog.global.cookieSplit+c),30)}}function getSession(){var b=getCookie(worklog.global.ddrtSessionName);return b?DeEight(b).split(worklog.global.cookieSplit):!1};